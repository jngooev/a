<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Inventory Count (Mobile)</title>
<style>
  :root{
    --bg:#0b0e10; --card:#141923; --text:#f3f7fb; --muted:#8fa6bf;
    --border:#27364d; --accent:#42a5ff; --accent2:#22cc88; --warn:#ffb020; --danger:#ff5d5d;
    --radius:14px; --pad:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  header{position:sticky;top:0;z-index:2;background:linear-gradient(#0b0e10,#0b0e1090);backdrop-filter:saturate(140%) blur(6px);padding:14px 16px;border-bottom:1px solid var(--border);}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .push{margin-left:auto}
  .btn{background:#111826;border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:999px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#00131e}
  .btn.success{background:var(--accent2);border-color:var(--accent2);color:#001a10}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#2b1b00}
  .btn.danger{background:var(--danger);border-color:var(--danger);color:#2b0000}
  .wrap{max-width:780px;margin:0 auto;padding:0 12px}
  .section{padding:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);}
  .list{display:flex;flex-direction:column}
  .item{padding:14px;border-bottom:1px solid var(--border);cursor:pointer}
  .item:last-child{border-bottom:none}
  .title{font-weight:600}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:.2rem .55rem;border:1px solid var(--border);border-radius:999px;color:var(--muted);margin-right:6px}
  .pill.today{background:var(--accent2);border-color:var(--accent2);color:#001a10;font-weight:600}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  @media (min-width:520px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .empty{padding:26px;text-align:center;color:var(--muted)}
  /* modal */
  .backdrop{position:fixed;inset:0;background:#0009;display:none;align-items:flex-end;justify-content:center;z-index:5}
  .sheet{background:var(--card);border:1px solid var(--border);border-bottom:none;border-radius:16px 16px 0 0;width:100%;max-width:720px;padding:16px}
  label{display:block;margin:10px 0 6px}
  input,select{width:100%;background:#0f1520;border:1px solid var(--border);color:var(--text);padding:10px;border-radius:10px}
  .row-end{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
  .tag{font-variant-numeric:tabular-nums;color:var(--muted)}
</style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="title">Inventory</div>
      <div class="push row">
        <button id="syncBtn" class="btn success" title="Send logs to Google">Sync</button>
        <button id="exportBtn" class="btn">Export logs</button>
        <button id="clearBtn" class="btn warn">Clear logs</button>
      </div>
    </div>
  </header>

  <main class="wrap section">
    <div id="status" class="muted" style="margin:6px 4px 10px"></div>

    <div class="card section" id="locCard">
      <div class="title" style="margin-bottom:8px">Locations</div>
      <div id="locList" class="grid"></div>
    </div>

    <div class="card section" id="itemsCard" style="margin-top:14px;display:none">
      <div class="row" style="margin-bottom:8px">
        <div class="title">Items in <span id="locName"></span></div>
        <button id="backBtn" class="btn" style="margin-left:auto">Back</button>
      </div>
      <div id="itemsList" class="list"></div>
    </div>
  </main>

  <div id="sheet" class="backdrop">
    <div class="sheet">
      <div class="title" id="sheetTitle">Count</div>
      <div class="muted" id="sheetSub" style="margin-bottom:10px"></div>

      <div id="countEntries">
        </div>
      
      <div class="row" style="margin-top:10px;justify-content:center">
        <button id="addCountBtn" class="btn" style="width:100%">Add Another UoM</button>
      </div>

      <div class="row-end">
        <button id="cancelBtn" class="btn">Cancel</button>
        <button id="saveBtn" class="btn primary">Save</button>
      </div>
    </div>
  </div>

<script>
/* ========= CONFIG ========= */
// Paste the **base** Web App URL from Apps Script (ends with /exec)
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwIEXkytbbXU3grZNR2Q4AR64FaT6NQqIwLp2nKbn92xSrywn0hUpE5wFr9U3xxyzj1/exec';
const STORAGE_KEY = 'inv_logs_v1';
const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';

/* ========= State ========= */
const state = {
  template: [],              // rows from Google
  byLocation: new Map(),     // location => rows[]
  logsByItemLoc: new Map(),  // Key format: item_id@location_id => log_row
  currentLocation: null,     // string
  currentItem: null          // selected row
};

/* ========= Utility ========= */
const $ = sel => document.querySelector(sel);
function setStatus(msg){ $('#status').textContent = msg || ''; }
function today(tzName=tz){
  const d = new Date();
  const fmt = new Intl.DateTimeFormat('en-CA',{timeZone:tzName,year:'numeric',month:'2-digit',day:'2-digit'});
  return fmt.format(d); // YYYY-MM-DD
}
function nowISO(){ return new Date().toISOString(); }
function readLogs(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch{return[]} }
function writeLogs(rows){ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); }

// NEW: Index logs by Item ID AND Location ID
function indexLogs(logs){ 
  state.logsByItemLoc = new Map();
  for(const r of logs){
    const key = `${r.item_id}@${r.location_id}`; // Use combined key
    // Keep only the latest log entry for the item_id@location_id
    const existing = state.logsByItemLoc.get(key);
    if(!existing || r.count_on > existing.count_on){
      state.logsByItemLoc.set(key, r);
    }
  }
}

function normalizeRow(r){
  const low = Object.fromEntries(Object.entries(r).map(([k,v])=>[String(k).toLowerCase().replace(/\s+/g,'_'), v]));
  const get =( ...names )=>{
    for (const k of names){ const v = low[k]; if (v!=null && String(v).trim()!=='') return String(v).trim(); }
    return '';
  };
  return {
    storage_location: get('storage_location','location'),
    location_id:      get('location_id','locationid'),
    template_id:      get('template_id','templateid'),
    item_id:          get('item_id','id','itemid'),
    item:             get('item','item_name','name'),
    uof_m:            get('uof_m','uom','unit'),
    uof_m_2:          get('uof_m_2','uom_2','unit_2'),
    uof_m_3:          get('uof_m_3','uom_3','unit_3'),
  };
}

/* ========= Fetch template (AUTO on load) ========= */
async function loadTemplateFromSheets(){
  const url = `${WEB_APP_URL}?mode=json&nocache=${Date.now()}`;
  setStatus('Loading template…');
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if(!json.ok || !Array.isArray(json.data)) throw new Error(json.error || 'Bad response');

    const rows = json.data.map(normalizeRow).filter(r=>r.template_id);
    state.template = rows;
    indexByLocation();
    renderLocations();
    setStatus(`Loaded ${rows.length} items • ${new Set(rows.map(r=>r.storage_location)).size} locations`);
  }catch(err){
    console.error(err);
    setStatus('Load failed: '+ err.message);
    alert('Load failed: ' + err.message);
  }
}

function indexByLocation(){
  state.byLocation = new Map();
  for(const r of state.template){
    const loc = r.storage_location || 'Unknown';
    if(!state.byLocation.has(loc)) state.byLocation.set(loc, []);
    state.byLocation.get(loc).push(r);
  }
  for(const arr of state.byLocation.values()){
    arr.sort((a,b)=> String(a.item).localeCompare(b.item));
  }
}

/* ========= Render ========= */
function renderLocations(){
  $('#itemsCard').style.display='none';
  $('#locCard').style.display='block';
  const wrap = $('#locList'); wrap.innerHTML='';
  if(state.byLocation.size===0){ wrap.innerHTML = `<div class="empty">No locations</div>`; return; }
  
  const todayCountedByLoc = new Map();
  const logs = readLogs().filter(l => l.business_date === today());
  for(const l of logs) { 
    const loc = l.storage_location || 'Unknown';
    if(!todayCountedByLoc.has(loc)) todayCountedByLoc.set(loc, new Set());
    todayCountedByLoc.get(loc).add(l.item_id);
  }

  for(const [loc, rows] of state.byLocation){
    const itemsCounted = todayCountedByLoc.get(loc)?.size || 0;
    const btn = document.createElement('button');
    btn.className='btn';
    btn.style.width='100%';
    btn.innerHTML = `<div class="row" style="justify-content:space-between">
      <span>${loc}</span><span class="tag">${rows.length} items • ${itemsCounted} today</span></div>`;
    btn.addEventListener('click', ()=> openLocation(loc));
    wrap.appendChild(btn);
  }
}

function openLocation(loc){
  state.currentLocation = loc;
  $('#locCard').style.display='none';
  $('#itemsCard').style.display='block';
  $('#locName').textContent = loc;
  const list = $('#itemsList'); list.innerHTML='';
  const rows = state.byLocation.get(loc) || [];
  if(!rows.length){ list.innerHTML = `<div class="empty">No items in ${loc}</div>`; return; }
  
  for(const r of rows){
    const li = document.createElement('div');
    li.className='item';
    
    // Use item_id@location_id key for specific lookup
    const lastCount = state.logsByItemLoc.get(`${r.item_id}@${r.location_id}`);
    let lastCountHtml = '';
    
    if(lastCount){
      // Display the first quantity/UoM entry as the primary indicator
      const primaryQty = lastCount['quantity_1'] || lastCount.quantity_1 || lastCount.quantity; 
      const primaryUofm = lastCount['count_uofm_1'] || lastCount.count_uofm_1 || lastCount.count_uofm;
      
      if (primaryQty > 0) {
        const isToday = lastCount.business_date === today();
        const countDate = new Date(lastCount.count_on).toLocaleDateString();
        const countTime = new Date(lastCount.count_on).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const pillClass = isToday ? 'today' : '';
        
        // Last count info display (quantity, uofm, date)
        lastCountHtml = `<div class="row" style="gap:8px;margin-top:6px;font-size:0.9em;font-weight:400">
          <span class="pill ${pillClass}">${primaryQty} ${primaryUofm}</span>
          <span class="muted">${isToday ? `Today ${countTime}` : countDate}</span>
        </div>`;
      }
    }
      
    li.innerHTML = `<div class="title">${r.item}</div>
      <div class="muted">${r.storage_location} • ID ${r.item_id}</div> 
      ${lastCountHtml}`; // Inject last count
      
    li.addEventListener('click', ()=> openSheet(r));
    list.appendChild(li);
  }
}

/* ========= Bottom sheet (Multi-Count) ========= */
function getUofmOptionsHtml(row){
  const units = [row.uof_m,row.uof_m_2,row.uof_m_3].filter(Boolean);
  if(units.length === 0) units.push('EA'); // Default if none defined
  
  return units.map(u => `<option value="${u}">${u}</option>`).join('');
}

function createCountRow(row, container){
  const optionsHtml = getUofmOptionsHtml(row);
  const wrapper = document.createElement('div');
  wrapper.className = 'row count-row'
  wrapper.style.marginBottom = '10px';
  
  // Quantity input
  const qtyInput = document.createElement('input');
  qtyInput.type = 'number';
  qtyInput.min = '0';
  qtyInput.inputMode = 'decimal';
  qtyInput.placeholder = '0';
  qtyInput.className = 'qtyInp';
  qtyInput.style.flex = '3';
  qtyInput.value = '';

  // UoM select
  const uofmSelect = document.createElement('select');
  uofmSelect.className = 'uofmSel';
  uofmSelect.style.flex = '2';
  uofmSelect.innerHTML = optionsHtml;
  
  // Remove button
  const removeBtn = document.createElement('button');
  removeBtn.className = 'btn danger';
  removeBtn.style.padding = '10px 10px';
  removeBtn.style.flex = '0 0 auto';
  removeBtn.textContent = '–';
  removeBtn.onclick = () => {
    if(container.querySelectorAll('.count-row').length > 1){
      container.removeChild(wrapper);
    } else {
      qtyInput.value = ''; // Just clear the last one
      uofmSelect.selectedIndex = 0;
    }
  };

  wrapper.appendChild(qtyInput);
  wrapper.appendChild(uofmSelect);
  wrapper.appendChild(removeBtn);
  container.appendChild(wrapper);
}

function openSheet(row){
  state.currentItem = row;
  $('#sheetTitle').textContent = row.item;
  $('#sheetSub').textContent = `${row.storage_location} • ${row.template_id} • ID ${row.item_id}`;
  
  const entriesContainer = $('#countEntries');
  entriesContainer.innerHTML = ''; // Clear previous entries
  
  createCountRow(row, entriesContainer); // Start with one row
  
  $('#sheet').style.display='flex';
}

function closeSheet(){ $('#sheet').style.display='none'; }


// Add button handler - Must be wired up outside of load in the DOMContentLoaded listener below
document.addEventListener('DOMContentLoaded', () => {
  const addCountBtn = $('#addCountBtn');
  if (addCountBtn) {
    addCountBtn.addEventListener('click', () => {
        if(state.currentItem) {
            createCountRow(state.currentItem, $('#countEntries'));
        }
    });
  }
});


/* ========= Save log (NEW: Save single consolidated log row) ========= */
async function saveCount(){ 
  const r = state.currentItem; if(!r) return;
  const entriesContainer = $('#countEntries');
  const countRows = entriesContainer.querySelectorAll('.count-row');
  const allLogs = readLogs();
  const todayKey = today();
  
  // 1. Gather all count data from the UI
  const countData = [];
  for(const rowEl of countRows){
    const qty = parseFloat(rowEl.querySelector('.qtyInp').value || '0');
    const uofm = rowEl.querySelector('.uofmSel').value || '';
    if(qty > 0 || uofm){ 
        countData.push({ quantity: qty, uofm: uofm });
    }
  }

  if(countData.length === 0) {
      closeSheet();
      setStatus('No quantity entered. Count canceled.');
      return;
  }
  
  // 2. Build the single consolidated log row (up to 3 UoM/Qty pairs)
  const consolidatedLog = {
    business_date: todayKey,
    count_on: nowISO(),
    storage_location: r.storage_location,
    location_id: r.location_id,
    template_id: r.template_id,
    item_id: r.item_id,
    item: r.item,
    'count_uofm_1': countData[0]?.uofm || '',
    'quantity_1': countData[0]?.quantity || 0,
    'count_uofm_2': countData[1]?.uofm || '',
    'quantity_2': countData[1]?.quantity || 0,
    'count_uofm_3': countData[2]?.uofm || '',
    'quantity_3': countData[2]?.quantity || 0,
    counted_by: '' // optional
  };
  
  // 3. Update Local Storage (Upsert: Find existing log for the same item/location/day and replace it)
  const logKey = `${r.item_id}@${r.location_id}`;
  const idx = allLogs.findIndex(x => 
      `${x.item_id}@${x.location_id}` === logKey && x.business_date === todayKey
  );
  
  if(idx>=0) allLogs[idx] = consolidatedLog; 
  else allLogs.push(consolidatedLog);
  
  writeLogs(allLogs);
  indexLogs(allLogs); 
  closeSheet();
  
  setStatus(`Saved count • Syncing...`);
  
  // 4. Auto-Sync the new consolidated row immediately
  const success = await syncSingleRowToGoogle(consolidatedLog);
  
  // 5. Re-render the current view
  if(success){
    setStatus(`Saved & Synced • ${r.item} (${countData.length} entries)`);
  } else {
    setStatus(`Saved (Local Only) • ${r.item} (${countData.length} entries)`);
  }
  renderLocations();
  if(state.currentLocation) openLocation(state.currentLocation);
}

// optional: send ONE row to Google (Apps Script doPost)
async function syncSingleRowToGoogle(row){
  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers:{'Content-Type':'text/plain'}, // avoid CORS preflight
      body: JSON.stringify({ action:'appendLogs', rows: [row] }) 
    });
    const json = await res.json();
    if(json.ok){ return true; }
    else{ throw new Error(json.error||'Failed'); }
  }catch(err){
    console.error('Single row sync failed:', err); 
    return false;
  }
}

/* ========= Export / Clear / Sync (Updated for Logs) ========= */
function toCSV(rows){
  if(!rows.length) return '';
  const headers = Object.keys(rows[0]);
  const esc = s => {
    const t = String(s??'').replace(/"/g,'""');
    return /[",\n]/.test(t) ? `"${t}"` : t;
  };
  return [headers.join(',')].concat(rows.map(r=>headers.map(h=>esc(r[h])).join(','))).join('\n');
}
function download(name, text){
  const blob = new Blob([text],{type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name;
  document.body.appendChild(a); a.click(); a.remove();
}
function exportLogs(){
  const rows = readLogs();
  if(!rows.length) return alert('No logs to export');
  download(`count_logs_${today()}.csv`, toCSV(rows));
}
function clearLogs(){
  if(!confirm('Clear all saved logs on this device?')) return;
  writeLogs([]); 
  indexLogs([]);
  setStatus('Logs cleared');
  renderLocations(); 
}

// optional: send ALL logs to Google (Apps Script doPost)
async function syncToGoogle(){
  const rows = readLogs();
  if(!rows.length){ alert('No logs to sync'); return; }
  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers:{'Content-Type':'text/plain'}, // avoid CORS preflight
      body: JSON.stringify({ action:'appendLogs', rows })
    });
    const json = await res.json();
    if(json.ok){ setStatus(`Synced ${json.inserted} rows to Google`); }
    else{ throw new Error(json.error||'Failed'); }
  }catch(err){
    console.error(err); alert('Sync failed: '+err.message);
  }
}


/* ========= Wire up ========= */
document.addEventListener('DOMContentLoaded', () => {
  // buttons
  $('#backBtn').addEventListener('click', ()=> renderLocations());
  $('#cancelBtn').addEventListener('click', closeSheet);
  $('#saveBtn').addEventListener('click', saveCount);
  $('#exportBtn').addEventListener('click', exportLogs);
  $('#clearBtn').addEventListener('click', clearLogs);
  $('#syncBtn').addEventListener('click', syncToGoogle);

  // AUTO-LOAD the Google Sheet template on page load
  indexLogs(readLogs());
  loadTemplateFromSheets();
});
</script>
</body>
</html>
