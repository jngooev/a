<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Inventory Count (Mobile)</title>
<style>
  :root{
    --bg:#0b0c10; --panel:#141923; --muted:#9fb0c6; --text:#f3f7fb;
    --border:#273041; --accent:#4f8cff; --ok:#2cd08c; --warn:#ffb020; --danger:#ff5a5a;
    --radius:16px; --sp:14px; --sp2:20px; --tap:52px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    -webkit-tap-highlight-color: transparent;
  }

  /* Header */
  header{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; gap:10px;
    height:64px; padding:0 var(--sp2);
    background:rgba(20,25,35,.9); backdrop-filter: blur(6px);
    border-bottom:1px solid var(--border);
  }
  .title{font-weight:700; font-size:18px; letter-spacing:.2px}
  .spacer{flex:1}
  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    padding:0 16px; height:var(--tap);
    border-radius:999px; border:1px solid var(--border);
    background:#202739; color:var(--text); font-weight:600; cursor:pointer;
  }
  .btn.primary{background:var(--accent); border-color:transparent}
  .btn.ghost{background:transparent}
  .btn:disabled{opacity:.55; cursor:not-allowed}

  /* Page container */
  .wrap{max-width:680px; margin:0 auto; padding:16px var(--sp2) 28px}
  .section{display:block}
  .hidden{display:none !important}

  /* Rows / cards */
  .row{
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); padding:14px; margin-bottom:12px;
    min-height:var(--tap); cursor:pointer;
  }
  .row:active{transform:translateY(1px)}
  .row .meta{font-size:12px; color:var(--muted)}
  .badge{
    padding:6px 10px; font-size:12px; border-radius:999px;
    background:#1a2130; color:var(--muted); border:1px solid var(--border);
  }
  .badge.ok{background:rgba(44,208,140,.18); color:#b6f6df; border-color:transparent}
  .badge.pending{background:#151c2a; color:#aec1df}

  /* Form */
  .card{
    background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); padding:16px; margin-bottom:14px;
  }
  label{display:block; font-size:13px; color:var(--muted); margin-bottom:8px}
  input{
    width:100%; height:var(--tap); padding:0 14px;
    border-radius:12px; border:1px solid var(--border);
    background:#0f131c; color:var(--text);
  }
  .uomBar{display:flex; gap:8px; flex-wrap:wrap}
  .uom{
    height:var(--tap); padding:0 14px; border-radius:999px; border:1px solid var(--border);
    background:#0f131c; color:var(--text); font-weight:600; cursor:pointer;
  }
  .uom.active{background:rgba(79,140,255,.15); border-color:var(--accent); color:#cfe1ff}
  .actions{display:flex; gap:10px; flex-wrap:wrap}
  .okText{color:#aaf5d9; font-size:13px}
  .note{color:var(--muted); font-size:12px}

  /* Mobile helpers */
  @media (max-width:420px){
    .wrap{padding-left:14px; padding-right:14px}
    .title{font-size:17px}
  }
</style>
</head>
<body>

<header>
  <button id="backBtn" class="btn" style="display:none">← Back</button>
  <div class="title" id="title">Inventory</div>
  <div class="spacer"></div>

  <!-- quick actions -->
  <label for="file" class="btn ghost">Load CSV</label>
  <input id="file" type="file" accept=".csv" style="display:none">
</header>

<main class="wrap">
  <!-- LOCATIONS -->
  <section id="viewLocations" class="section">
    <!-- filled by JS -->
  </section>

  <!-- ITEMS IN LOCATION -->
  <section id="viewItems" class="section hidden"></section>

  <!-- COUNT FORM -->
  <section id="viewDetail" class="section hidden"></section>

  <!-- UTILITIES -->
  <div class="actions">
    <button id="exportBtn" class="btn ghost">Export logs</button>
    <button id="clearBtn" class="btn ghost">Clear logs</button>
  </div>
</main>

<script>
/* ========= CSV parser (simple) ========= */
function parseCSV(text){
  const rows=[]; let i=0, cell='', inQ=false, row=[];
  while(i<text.length){
    const c=text[i], n=text[i+1];
    if(c==='"' && inQ && n==='"'){ cell+='"'; i+=2; continue; }
    if(c==='"'){ inQ=!inQ; i++; continue; }
    if(c===',' && !inQ){ row.push(cell.trim()); cell=''; i++; continue; }
    if((c==='\n'||c==='\r') && !inQ){ if(cell.length||row.length){row.push(cell.trim()); rows.push(row); row=[]; cell='';}
      if(c==='\r'&&n==='\n') i+=2; else i++; continue; }
    cell+=c; i++;
  }
  if(cell.length||row.length){ row.push(cell.trim()); rows.push(row); }
  const headers = rows.shift().map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));
  return rows.filter(r=>r.some(x=>x)).map(r=>Object.fromEntries(headers.map((h,idx)=>[h, r[idx]??''])));
}

/* ========= Local state ========= */
const state = {
  template: [],
  byLocation: {},
  currentLocation: null,
  currentItem: null,
  tz: 'America/Los_Angeles'
};

const $ = s => document.querySelector(s);
const todayLocal = () => {
  try{ return new Intl.DateTimeFormat('en-CA',{timeZone:state.tz,year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date()); }
  catch(e){ return new Date().toISOString().slice(0,10); }
};
const LOG_KEY='inv_logs_v2';
const readLogs = () => JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
const writeLogs = arr => localStorage.setItem(LOG_KEY, JSON.stringify(arr));
const latestLogFor = id => readLogs().filter(l=>l.template_id===id).sort((a,b)=>b.count_on.localeCompare(a.count_on))[0]||null;
function upsertLog(entry){
  const logs = readLogs();
  const business_date = todayLocal();
  const idx = logs.findIndex(l => l.template_id===entry.template_id && l.business_date===business_date);
  const record = {...entry, quantity:+entry.quantity, business_date, count_on:new Date().toISOString()};
  if(idx>=0) logs[idx] = {...logs[idx], ...record}; else logs.push(record);
  writeLogs(logs);
  return record;
}

/* ========= Navigation helpers ========= */
function show(sectionId){
  ['viewLocations','viewItems','viewDetail'].forEach(id => $('#'+id).classList.add('hidden'));
  $('#'+sectionId).classList.remove('hidden');
}
function setTitle(t){ $('#title').textContent=t; }

/* ========= Build screens ========= */
function indexByLocation(){
  const map={};
  state.template.forEach(r=>{
    const loc = r.storage_location || r.location || r.location_name || 'Unknown';
    (map[loc] ||= []).push(r);
  });
  state.byLocation = map;
}
function renderLocations(){
  setTitle('Inventory');
  $('#backBtn').style.display='none';
  show('viewLocations');
  const root = $('#viewLocations');
  root.innerHTML='';
  Object.entries(state.byLocation).forEach(([loc, rows])=>{
    const counted = rows.filter(r => !!latestLogFor(r.template_id) && latestLogFor(r.template_id).business_date===todayLocal()).length;
    const el = document.createElement('div');
    el.className='row';
    el.innerHTML=`
      <div>
        <div style="font-weight:700;font-size:16px">${loc}</div>
        <div class="meta">Items: ${rows.length}</div>
      </div>
      <span class="badge ${counted?'ok':'pending'}">${counted? counted+' counted' : 'pending'}</span>
    `;
    el.onclick=()=>{ state.currentLocation=loc; renderItems(loc); };
    root.appendChild(el);
  });
}

function renderItems(loc){
  setTitle(loc);
  $('#backBtn').style.display='inline-flex';
  show('viewItems');
  const root = $('#viewItems'); root.innerHTML='';
  (state.byLocation[loc]||[]).forEach(row=>{
    const last = latestLogFor(row.template_id);
    const countedToday = !!last && last.business_date===todayLocal();
    const el = document.createElement('div');
    el.className='row';
    el.style.borderColor = countedToday? 'rgba(44,208,140,.35)': 'var(--border)';
    el.innerHTML=`
      <div>
        <div style="font-weight:700">${row.item || row.item_name || ('Item '+row.item_id)}</div>
        <div class="meta">ID ${row.item_id} • Template ${row.template_id}</div>
        ${ last ? `<div class="okText">Last: ${last.quantity} ${last.count_uofm} • ${last.business_date}</div>`:''}
      </div>
      <span class="badge ${countedToday?'ok':'pending'}">${countedToday?'counted':'pending'}</span>
    `;
    el.onclick=()=>{ state.currentItem=row; renderDetail(row); };
    root.appendChild(el);
  });
}

function renderDetail(row){
  setTitle('Count Item');
  $('#backBtn').style.display='inline-flex';
  show('viewDetail');
  const uoms = [row.uof_m,row.uof_m_2,row.uof_m_3].filter(Boolean);
  const last = latestLogFor(row.template_id);
  const countedToday = last && last.business_date===todayLocal();
  const root = $('#viewDetail');

  root.innerHTML = `
    <div class="card">
      <div style="font-weight:700; font-size:18px">${row.item || row.item_name}</div>
      <div class="meta">Location: ${row.storage_location || state.currentLocation} • Item ID: ${row.item_id}</div>
    </div>

    <div class="card">
      <label>Unit of Measure</label>
      <div class="uomBar" id="uomBar">
        ${uoms.map((u,i)=>`<button class="uom" data-u="${u}">${u}</button>`).join('')}
      </div>
    </div>

    <div class="card">
      <label>Quantity</label>
      <input id="qty" type="text" inputmode="decimal" autocomplete="off" placeholder="0" />
    </div>

    <div class="card">
      ${(last?`<div class="note">Last count: <b>${last.quantity} ${last.count_uofm}</b> on ${last.business_date}</div>`:'<div class="note">No previous count</div>')}
      ${countedToday?'<div style="margin-top:8px" class="okText">An entry for today exists. Saving will update it.</div>':''}
      <div class="actions" style="margin-top:10px">
        <button class="btn primary" id="saveBtn">Save</button>
        <button class="btn" id="cancelBtn">Back</button>
      </div>
    </div>
  `;

  let chosenUOM = '';
  const uomBar = $('#uomBar');
  uomBar.querySelectorAll('.uom').forEach(btn=>{
    btn.onclick = ()=>{
      uomBar.querySelectorAll('.uom').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active'); chosenUOM = btn.dataset.u;
    };
  });

  $('#cancelBtn').onclick = ()=> renderItems(state.currentLocation);
  $('#saveBtn').onclick = ()=>{
    const qty = ($('#qty').value || '').trim();
    if(!chosenUOM){ alert('Pick a unit of measure'); return; }
    if(!qty || isNaN(qty) || +qty<=0){ alert('Enter a quantity > 0'); return; }
    upsertLog({
      template_id: row.template_id,
      item_id: row.item_id,
      item: row.item || row.item_name,
      location_id: row.location_id || row.storage_location || state.currentLocation,
      storage_location: row.storage_location || state.currentLocation,
      count_uofm: chosenUOM,
      quantity: qty,
      counted_by: 'user'
    });
    alert('Saved');
    renderItems(state.currentLocation);
  };
}

/* ========= File / export / clear ========= */
$('#file').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    state.template = parseCSV(r.result);
    indexByLocation(); renderLocations();
  };
  r.readAsText(f);
});

$('#exportBtn').onclick = ()=>{
  const logs = readLogs();
  if(!logs.length) return alert('No logs yet');
  const headers = Object.keys(logs[0]);
  const csv = [headers.join(',')].concat(
    logs.map(r => headers.map(h=>{
      const v = r[h] ?? ''; const s = String(v).replace(/"/g,'""');
      return /[",\n]/.test(s) ? `"${s}"` : s;
    }).join(','))
  ).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:`count_logs_${todayLocal()}.csv`});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

$('#clearBtn').onclick = ()=>{
  if(confirm('Clear all logs from this device?')){ writeLogs([]); alert('Cleared'); renderLocations(); }
};

$('#backBtn').onclick = ()=>{
  if(!$('#viewDetail').classList.contains('hidden')) renderItems(state.currentLocation);
  else renderLocations();
};

/* ========= PWA hook (optional; add sw.js to enable) ========= */
if('serviceWorker' in navigator){
  // navigator.serviceWorker.register('/sw.js'); // uncomment when you add a service worker
}

const WEB_APP_URL = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjAAAcemK6qQsCw7nqR3RsOUxdurX3RRgD73axOthELHNWmp69EXGWT4mV_HL7wd84jTIp6lp5uYGvcxtQPMkuBz1Aq85ROSfTUlgQR9twleW5otOzo8VA0A2_0nH2lykrSniBwa0caATxE_ZbZ6mzc5fh5Wfc4qIi1zitrivuaoDLGUC_boWId_AAcTirmPus-4PZKkMg3jhhmAWQv2zDQ7ARtPCPaBnK4p756-RTvT_pWJzPpPk0qANRCWymIpjpT6FJTKkfZ5NfqfDvLK8r3Je_5dIVQT6glqYXj&lib=MicarClhAzR6lQRsYQBG0rCq1-vRkhSuq';

// Load template from Sheets (CSV)
async function loadTemplateFromSheets() {
  const url = `${WEB_APP_URL}?mode=json&nocache=${Date.now()}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Template fetch failed: ${res.status}`);
  const json = await res.json();

  if (!json.ok || !Array.isArray(json.data)) {
    console.error('Template error:', json);
    throw new Error(json.error || 'Bad template response');
  }

  const cleaned = json.data.map(row => {
    // lower-case keys for robustness
    const lowered = Object.fromEntries(
      Object.entries(row).map(([k,v]) => [String(k).toLowerCase().replace(/\s+/g,'_'), v])
    );
    return normalizeRow(lowered);
  }).filter(r => r.template_id); // drop blank rows

  if (!cleaned.length) {
    throw new Error('No usable rows after normalization. Check header names.');
  }

  state.template = cleaned;
  indexByLocation();
  renderLocations();

  // Optional: sanity log
  console.log('Loaded template rows:', cleaned.length, cleaned.slice(0,3));
}

</script>
</body>
</html>
