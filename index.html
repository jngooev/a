<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Inventory Count (Mobile)</title>
<style>
  :root{
    --bg:#0b0e10; --card:#141923; --text:#f3f7fb; --muted:#8fa6bf;
    --border:#27364d; --accent:#42a5ff; --accent2:#22cc88; --warn:#ffb020; --danger:#ff5d5d;
    --radius:14px; --pad:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  header{position:sticky;top:0;z-index:2;background:linear-gradient(#0b0e10,#0b0e1090);backdrop-filter:saturate(140%) blur(6px);padding:14px 16px;border-bottom:1px solid var(--border);}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .push{margin-left:auto}
  .btn{background:#111826;border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:999px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#00131e}
  .btn.success{background:var(--accent2);border-color:var(--accent2);color:#001a10}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#2b1b00}
  .btn.danger{background:var(--danger);border-color:var(--danger);color:#2b0000}
  .wrap{max-width:780px;margin:0 auto;padding:0 12px}
  .section{padding:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);}
  .list{display:flex;flex-direction:column}
  .item{padding:14px;border-bottom:1px solid var(--border);cursor:pointer}
  .item:last-child{border-bottom:none}
  .title{font-weight:600}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:.2rem .55rem;border:1px solid var(--border);border-radius:999px;color:var(--muted);margin-right:6px}
  .pill.today{background:var(--accent2);border-color:var(--accent2);color:#001a10;font-weight:600} /* Added for Today's Count */
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  @media (min-width:520px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .empty{padding:26px;text-align:center;color:var(--muted)}
  /* modal */
  .backdrop{position:fixed;inset:0;background:#0009;display:none;align-items:flex-end;justify-content:center;z-index:5}
  .sheet{background:var(--card);border:1px solid var(--border);border-bottom:none;border-radius:16px 16px 0 0;width:100%;max-width:720px;padding:16px}
  label{display:block;margin:10px 0 6px}
  input,select{width:100%;background:#0f1520;border:1px solid var(--border);color:var(--text);padding:10px;border-radius:10px}
  .row-end{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
  .tag{font-variant-numeric:tabular-nums;color:var(--muted)}
</style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="title">Inventory</div>
      <div class="push row">
        <button id="syncBtn" class="btn success" title="Refresh count logs from Google">Refresh</button>
        <button id="exportBtn" class="btn">Export logs</button>
        <button id="clearBtn" class="btn warn">Clear logs</button>
      </div>
    </div>
  </header>

  <main class="wrap section">
    <div id="status" class="muted" style="margin:6px 4px 10px"></div>

    <div class="card section" id="locCard">
      <div class="title" style="margin-bottom:8px">Locations</div>
      <div id="locList" class="grid"></div>
    </div>

    <div class="card section" id="itemsCard" style="margin-top:14px;display:none">
      <div class="row" style="margin-bottom:8px">
        <div class="title">Items in <span id="locName"></span></div>
        <button id="backBtn" class="btn" style="margin-left:auto">Back</button>
      </div>
      <div id="itemsList" class="list"></div>
    </div>
  </main>

  <div id="sheet" class="backdrop">
    <div class="sheet">
      <div class="title" id="sheetTitle">Count</div>
      <div class="muted" id="sheetSub" style="margin-bottom:10px"></div>

      <div id="countEntries">
        </div>
      
      <div class="row" style="margin-top:10px;justify-content:center">
        <button id="addCountBtn" class="btn" style="width:100%">Add Another UoM</button>
      </div>

      <div class="row-end">
        <button id="cancelBtn" class="btn">Cancel</button>
        <button id="saveBtn" class="btn primary">Save</button>
      </div>
    </div>
  </div>

<script>
/* ========= CONFIG ========= */
// Paste the **base** Web App URL from Apps Script (ends with /exec)
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwIEXkytbbXU3grZNR2Q4AR64FaT6NQqIwLp2nKbn92xSrywn0hUpE5wFr9U3xxyzj1/exec';
const STORAGE_KEY = 'inv_logs_v1';
const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';

/* ========= State ========= */
const state = {
  template: [],              // rows from Google
  byLocation: new Map(),     // location => rows[]
  logsByItemLoc: new Map(),  // Key format: item_id@location_id => log_row
  currentLocation: null,     // string
  currentItem: null          // selected row
};

/* ========= Utility ========= */
const $ = sel => document.querySelector(sel);
function setStatus(msg){ $('#status').textContent = msg || ''; }
function today(tzName=tz){
  const d = new Date();
  const fmt = new Intl.DateTimeFormat('en-CA',{timeZone:tzName,year:'numeric',month:'2-digit',day:'2-digit'});
  return fmt.format(d); // YYYY-MM-DD
}
function nowISO(){ return new Date().toISOString(); }
function readLogs(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch{return[]} }
function writeLogs(rows){ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); }

// REVISED: Index logs by Item ID AND Location ID, prioritizing newest entry via robust sorting
function indexLogs(logRows){ 
  // 1. Group all logs by a unique item/location key
  const logsByKey = new Map();
  for(const r of logRows){
    const key = `${r.item_id}@${r.location_id}`; 
    if(!logsByKey.has(key)) logsByKey.set(key, []);
    logsByKey.get(key).push(r);
  }
  
  // 2. Clear the old state map and rebuild it with only the newest entry per key
  state.logsByItemLoc = new Map();
  for(const [key, logs] of logsByKey){
      // Sort logs by count_on (ISO string) descending. ISO strings sort chronologically.
      // We use .localeCompare for safe string comparison which works for ISO dates.
      logs.sort((a,b) => String(b.count_on || '').localeCompare(String(a.count_on || '')));
      
      // The first element is the newest log for this item/location combination.
      state.logsByItemLoc.set(key, logs[0]);
  }

  // Re-render only if the template is already loaded.
  if(state.template.length > 0) {
      renderLocations();
      // Only attempt to open the location if one was already open
      if(state.currentLocation) openLocation(state.currentLocation);
  }
}

function normalizeRow(r){
  const low = Object.fromEntries(Object.entries(r).map(([k,v])=>[String(k).toLowerCase().replace(/\s+/g,'_'), v]));
  const get =( ...names )=>{
    for (const k of names){ const v = low[k]; if (v!=null && String(v).trim()!=='') return String(v).trim(); }
    return '';
  };
  return {
    storage_location: get('storage_location','location'),
    location_id:      get('location_id','locationid'),
    template_id:      get('template_id','templateid'),
    item_id:          get('item_id','id','itemid'),
    item:             get('item','item_name','name'),
    uof_m:            get('uof_m','uom','unit'),
    uof_m_2:          get('uof_m_2','uom_2','unit_2'),
    uof_m_3:          get('uof_m_3','uom_3','unit_3'),
  };
}

/* ========= Fetch template (AUTO on load) ========= */
async function loadTemplateFromSheets(){
  const url = `${WEB_APP_URL}?mode=json&nocache=${Date.now()}`;
  setStatus('Loading template…');
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if(!json.ok || !Array.isArray(json.data)) throw new Error(json.error || 'Bad response');

    const rows = json.data.map(normalizeRow).filter(r=>r.template_id);
    state.template = rows;
    indexByLocation();
    renderLocations();
    setStatus(`Loaded ${rows.length} items • ${new Set(rows.map(r=>r.storage_location)).size} locations`);
    
    // CRITICAL: Load logs after template is successful
    await loadLogsFromSheets();

  }catch(err){
    console.error(err);
    setStatus('Load failed: '+ err.message);
    alert('Load failed: ' + err.message);
  }
}

// NEW: Fetch Count Logs from Sheets (READ-ONLY)
async function loadLogsFromSheets(){
  const url = `${WEB_APP_URL}?mode=logs&nocache=${Date.now()}`;
  setStatus('Loading count logs from spreadsheet...');
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if(!json.ok || !Array.isArray(json.data)) throw new Error(json.error || 'Bad logs response');
    
    // Ensure all required fields are present and correctly typed for remote logs
    const remoteLogs = json.data.map(r => ({
        ...r,
        // Ensure ISO format for count_on for comparison
        count_on: r.count_on || nowISO(), 
        // Ensure date field is present for 'today' check
        business_date: String(r.business_date || today()).substring(0, 10), // Ensures YYYY-MM-DD format
        // Ensure quantities are parsed as numbers for correct display
        quantity_1: parseFloat(r.quantity_1 || 0),
        quantity_2: parseFloat(r.quantity_2 || 0),
        quantity_3: parseFloat(r.quantity_3 || 0),
    }));

    // CRITICAL FIX: Combine local logs (which might have unsynced data) with new remote logs.
    const localLogs = readLogs(); 
    const allLogsToMerge = localLogs.concat(remoteLogs);

    // Index the complete set to get the single latest count per item/location
    indexLogs(allLogsToMerge); 
    setStatus(`Logs loaded. ${remoteLogs.length} remote logs merged with local cache.`);

  }catch(err){
    console.error('Remote log loading failed:', err);
    setStatus('Template loaded. Warning: Failed to load remote logs.'); 
    // Do not alert, allow app to continue if log loading fails
  }
}

function indexByLocation(){
  state.byLocation = new Map();
  for(const r of state.template){
    const loc = r.storage_location || 'Unknown';
    if(!state.byLocation.has(loc)) state.byLocation.set(loc, []);
    state.byLocation.get(loc).push(r);
  }
  for(const arr of state.byLocation.values()){
    arr.sort((a,b)=> String(a.item).localeCompare(b.item));
  }
}

/* ========= Render ========= */
function renderLocations(){
  $('#itemsCard').style.display='none';
  $('#locCard').style.display='block';
  const wrap = $('#locList'); wrap.innerHTML='';
  if(state.byLocation.size===0){ wrap.innerHTML = `<div class="empty">No locations</div>`; return; }
  
  const todayKey = today();
  const todayCountedByLoc = new Map();
  
  // Iterate over all the latest logs (local + remote)
  for(const [key, log] of state.logsByItemLoc){ 
    const loc = log.storage_location || 'Unknown';
    // CRITICAL: Check if the log's business_date matches today
    if(log.business_date === todayKey){ 
        if(!todayCountedByLoc.has(loc)) todayCountedByLoc.set(loc, new Set());
        // Use item_id for counting unique items
        todayCountedByLoc.get(loc).add(log.item_id); 
    }
  }

  for(const [loc, rows] of state.byLocation){
    // Get the number of unique items counted today in this location
    const itemsCounted = todayCountedByLoc.get(loc)?.size || 0;
    const btn = document.createElement('button');
    btn.className='btn';
    btn.style.width='100%';
    btn.innerHTML = `<div class="row" style="justify-content:space-between">
      <span>${loc}</span><span class="tag">${rows.length} items • ${itemsCounted} today</span></div>`;
    btn.addEventListener('click', ()=> openLocation(loc));
    wrap.appendChild(btn);
  }
}

function openLocation(loc){
  state.currentLocation = loc;
  $('#locCard').style.display='none';
  $('#itemsCard').style.display='block';
  $('#locName').textContent = loc;
  const list = $('#itemsList'); list.innerHTML='';
  const rows = state.byLocation.get(loc) || [];
  if(!rows.length){ list.innerHTML = `<div class="empty">No items in ${loc}</div>`; return; }
  
  for(const r of rows){
    const li = document.createElement('div');
    li.className='item';
    
    // Use item_id@location_id key for specific lookup
    const lastCount = state.logsByItemLoc.get(`${r.item_id}@${r.location_id}`);
    let lastCountHtml = '';
    
    if(lastCount){
      // Display the first quantity/UoM entry as the primary indicator
      const primaryQty = lastCount['quantity_1']; 
      const primaryUofm = lastCount['count_uofm_1']; 
      
      // Changed from (primaryQty > 0) to check if a quantity was recorded (0 is a recorded quantity)
      // Check if primaryQty is a non-negative number and primaryUofm exists
      if (primaryQty >= 0 && primaryUofm) { 
        // CRITICAL: Check the business_date field in the log entry
        const isToday = lastCount.business_date === today(); 
        const countDate = new Date(lastCount.count_on).toLocaleDateString();
        const countTime = new Date(lastCount.count_on).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const pillClass = isToday ? 'today' : '';
        // REVISED: If it's today, show "Today [Time]". Otherwise, show "[Date] [Time]".
        const dateDisplay = isToday 
          ? `Today ${countTime}` 
          : `${countDate} ${countTime}`;
        
        // Last count info display (quantity, uofm, date)
        lastCountHtml = `<div class="row" style="gap:8px;margin-top:6px;font-size:0.9em;font-weight:400">
          <span class="pill ${pillClass}">${primaryQty} ${primaryUofm}</span>
          <span class="muted">${dateDisplay}</span>
        </div>`;
      }
    }
      
    li.innerHTML = `<div class="title">${r.item}</div>
      <div class="muted">${r.storage_location} • ID ${r.item_id}</div> 
      ${lastCountHtml}`; // Inject last count
      
    li.addEventListener('click', ()=> openSheet(r));
    list.appendChild(li);
  }
}

/* ========= Bottom sheet (Multi-Count) ========= */
// REVISED: Forces 'Select UoM' placeholder as the default/selected option.
function getUofmOptionsHtml(row){
  const units = [row.uof_m,row.uof_m_2,row.uof_m_3].filter(Boolean);
  if(units.length === 0) units.push('EA'); // Default if none defined
  
  // Add placeholder option: value="" is important for validation
  let optionsHtml = '<option value="" disabled selected>Select UoM</option>';

  // Append actual options
  optionsHtml += units.map(u => `<option value="${u}">${u}</option>`).join('');
  
  return optionsHtml;
}

function createCountRow(row, container){
  const optionsHtml = getUofmOptionsHtml(row);
  const wrapper = document.createElement('div');
  wrapper.className = 'row count-row'
  wrapper.style.marginBottom = '10px';
  
  // Quantity input
  const qtyInput = document.createElement('input');
  qtyInput.type = 'number';
  qtyInput.min = '0';
  qtyInput.inputMode = 'decimal';
  qtyInput.placeholder = '0';
  qtyInput.className = 'qtyInp';
  qtyInput.style.flex = '3';
  qtyInput.value = ''; // Ensure quantity starts empty (no default 0)

  // UoM select
  const uofmSelect = document.createElement('select');
  uofmSelect.className = 'uofmSel';
  uofmSelect.style.flex = '2';
  uofmSelect.innerHTML = optionsHtml;
  
  // Remove button
  const removeBtn = document.createElement('button');
  removeBtn.className = 'btn danger';
  removeBtn.style.padding = '10px 10px';
  removeBtn.style.flex = '0 0 auto';
  removeBtn.textContent = '–';
  removeBtn.onclick = () => {
    if(container.querySelectorAll('.count-row').length > 1){
      container.removeChild(wrapper);
    } else {
      qtyInput.value = ''; // Just clear the quantity
      uofmSelect.value = ''; // Reset UoM to the empty placeholder value
    }
  };

  wrapper.appendChild(qtyInput);
  wrapper.appendChild(uofmSelect);
  wrapper.appendChild(removeBtn);
  container.appendChild(wrapper);
}

function openSheet(row){
  state.currentItem = row;
  $('#sheetTitle').textContent = row.item;
  $('#sheetSub').textContent = `${row.storage_location} • ${row.template_id} • ID ${row.item_id}`;
  
  const entriesContainer = $('#countEntries');
  entriesContainer.innerHTML = ''; // Clear previous entries
  
  createCountRow(row, entriesContainer); // Start with one row
  
  $('#sheet').style.display='flex';
}

function closeSheet(){ $('#sheet').style.display='none'; }


// Add button handler
document.addEventListener('DOMContentLoaded', () => {
  // ... other event listeners ...
  const addCountBtn = $('#addCountBtn');
  if (addCountBtn) {
    addCountBtn.addEventListener('click', () => {
        if(state.currentItem) {
            createCountRow(state.currentItem, $('#countEntries'));
        }
    });
  }
});

// optional: send ONE row to Google (Apps Script doPost)
async function syncSingleRowToGoogle(row){
  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers:{'Content-Type':'text/plain'}, // avoid CORS preflight
      body: JSON.stringify({ action:'appendLogs', rows: [row] }) 
    });
    const json = await res.json();
    if(json.ok){ return true; }
    else{ throw new Error(json.error||'Failed'); }
  }catch(err){
    console.error('Single row sync failed:', err); 
    return false;
  }
}

/* ========= Save log (Local Save and Auto-Sync) ========= */
async function saveCount(){ 
  const r = state.currentItem; if(!r) return;
  const entriesContainer = $('#countEntries');
  const countRows = entriesContainer.querySelectorAll('.count-row');
  const allLogs = readLogs();
  const todayKey = today();
  
  // 1. Gather all count data from the UI and perform validation
  const countData = [];
  for(const rowEl of countRows){
    // Use parseFloat to get the quantity as a number (NaN if empty or non-numeric)
    const qty = parseFloat(rowEl.querySelector('.qtyInp').value); 
    // The value will be an empty string if the 'Select UoM' placeholder is chosen
    const uofm = rowEl.querySelector('.uofmSel').value; 
    
    // MODIFIED: Only capture valid counts if UoM is selected AND Quantity is a valid number (0 or greater).
    // The input has min="0", so we just need to ensure it's not NaN (i.e., not empty).
    if(uofm !== '' && !isNaN(qty)) { 
        countData.push({ quantity: qty, uofm: uofm });
    }
  }

  // --- VALIDATION CHECK ---
  if(countData.length === 0) {
      alert('Error: You must enter a quantity (0 or greater) AND select a Unit of Measure (UoM) for at least one entry before saving.');
      return; // Stop the save process
  }
  
  // 2. Build the single consolidated log row (up to 3 UoM/Qty pairs)
  // *** USING UNDERSCORE KEYS (snake_case) to match Apps Script ***
  const consolidatedLog = {
    business_date: todayKey,
    count_on: nowISO(), // ISO string is correct
    storage_location: r.storage_location,
    location_id: r.location_id,
    template_id: r.template_id,
    item_id: r.item_id,
    item: r.item,
    'count_uofm_1': countData[0]?.uofm || '',
    'quantity_1': countData[0]?.quantity || 0,
    'count_uofm_2': countData[1]?.uofm || '',
    'quantity_2': countData[1]?.quantity || 0,
    'count_uofm_3': countData[2]?.uofm || '',
    'quantity_3': countData[2]?.quantity || 0,
    counted_by: '' // optional
  };
  
  // 3. Update Local Storage 
  const logKey = `${r.item_id}@${r.location_id}`;
  const idx = allLogs.findIndex(x => 
      `${x.item_id}@${x.location_id}` === logKey && x.business_date === todayKey
  );
  
  if(idx>=0) allLogs[idx] = consolidatedLog; 
  else allLogs.push(consolidatedLog);
  
  writeLogs(allLogs);
  
  // CRITICAL FIX: Index the full, updated local array. This ensures today's count is immediately visible.
  indexLogs(allLogs); 
  closeSheet();
  
  // 4. AUTO-SYNC the new consolidated row immediately
  setStatus(`Saved count • Syncing...`);
  const success = await syncSingleRowToGoogle(consolidatedLog);
  
  // 5. Update Status Message based on sync result
  if(success){
    setStatus(`Saved & Synced • ${r.item} (${countData.length} entries)`);
  } else {
    // Advise user to use the Refresh button to pull data from the sheet if sync failed
    setStatus(`Saved (Local Only) • ${r.item} (${countData.length} entries). Press Refresh to pull the latest sheet data.`);
  }
}


/* ========= Export / Clear / Refresh Logs (READ-ONLY) ========= */
function toCSV(rows){
  if(!rows.length) return '';
  const headers = Object.keys(rows[0]);
  const esc = s => {
    const t = String(s??'').replace(/"/g,'""');
    return /[",\n]/.test(t) ? `"${t}"` : t;
  };
  return [headers.join(',')].concat(rows.map(r=>headers.map(h=>esc(r[h])).join(','))).join('\n');
}
function download(name, text){
  const blob = new Blob([text],{type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name;
  document.body.appendChild(a); a.click(); a.remove();
}
function exportLogs(){
  const rows = readLogs();
  if(!rows.length) return alert('No logs to export');
  download(`count_logs_${today()}.csv`, toCSV(rows));
}
function clearLogs(){
  if(!confirm('Clear all saved logs on this device? This cannot be undone.')) return;
  writeLogs([]); 
  indexLogs([]);
  setStatus('Logs cleared');
  renderLocations(); 
}

// Function wired to the "Refresh" button (id=syncBtn) to READ logs
async function refreshLogsFromSheet(){
  setStatus('Manually refreshing logs from Google Sheet...');
  
  // Calls loadLogsFromSheets which performs the fetch, merge, and UI update (READ only)
  await loadLogsFromSheets();
}


/* ========= Wire up ========= */
document.addEventListener('DOMContentLoaded', () => {
  // buttons
  $('#backBtn').addEventListener('click', ()=> renderLocations());
  $('#cancelBtn').addEventListener('click', closeSheet);
  $('#saveBtn').addEventListener('click', saveCount);
  $('#exportBtn').addEventListener('click', exportLogs);
  $('#clearBtn').addEventListener('click', clearLogs);
  
  // Wire the "Refresh" button (id=syncBtn) to the log-reading function
  $('#syncBtn').addEventListener('click', refreshLogsFromSheet);

  // AUTO-LOAD the Google Sheet template on page load
  indexLogs(readLogs()); // 1. Load local logs first
  loadTemplateFromSheets(); // 2. Load template, then load remote logs (ONLY ONCE)
});
</script>
</body>
</html>
